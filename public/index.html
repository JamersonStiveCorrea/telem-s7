<!DOCTYPE html>

<html>
<head>
    <title>Samples</title>
</head>

<body>
    <h1>Samples</h1>
    <div id="apiKey"></div>
    <div id="content"></div>

    <script src="https://unpkg.com/babel-standalone@6/babel.js"></script>
    <script src="https://unpkg.com/react@15/dist/react.js"></script>
    <script src="https://unpkg.com/react-dom@15/dist/react-dom.js"></script>

    <script type="text/babel">
    var Samples = React.createClass({
        getInitialState: function() {
            return ({
                isLoaded: false,
                samples: []
            });
        },
        componentDidMount: function() {
            fetch('/api/samples?apiKey=' + document.getElementById('apiKey').textContent)
                .then(function(data) {
                    return data.json();
                }).then(json => {
                    this.setState({
                        isLoaded: true,
                        samples: json
                    });
                });
        },
        render: function() {
            var {isLoaded, samples} = this.state;

            if(!isLoaded) {
                return <div>Loading...</div>
            } else {
                return (
                    <div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Temperature</th>
                                    <th>Humidity</th>
                                    <th>Longitude</th>
                                    <th>Latitude</th>
                                </tr>    
                            </thead>
                            <tbody>
                            {
                                samples.map((sample, index) => (
                                    <tr key={index}>
                                        <td>{sample.temperature} Â°C</td>
                                        <td>{sample.humidity * 100} %</td>
                                        <td>{sample.location.coordinates[0]}</td>
                                        <td>{sample.location.coordinates[1]}</td>
                                    </tr>
                                ))
                            }
                            </tbody>
                        </table>
                    </div>
                );
            }
        }
    });

    var SignUp = React.createClass({
        render: function () {
            return (
               <form onSubmit={this.signUp}>
                    <label>Username:</label>
                    <input type="text" ref="username" required/>
                    <label>Password:</label>
                    <input type="password" ref="password" required/>
                    <input type="submit" value="new"/>
                </form>
            );
        },
        signUp: function (e) {
            e.preventDefault();

            var vars = JSON.stringify({
                username: this.refs.username.value,
                password: this.refs.password.value
            });

            fetch('/users/new', {
                method: 'post',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: vars
            }).then((res) => {
                if(res.status === 201){
                    ReactDOM.render(<Login/>, document.getElementById('content'));
                } else {
                    alert("User already exists");
                }
            }).catch(err => console.log(err));
        }
    });

    var Login = React.createClass({
        render: function () {
            return (
                <div>
                    <form onSubmit={this.login}>
                        <label>Username:</label>
                        <input type="text" ref="username" required/>
                        <label>Password:</label>
                        <input type="password" ref="password" required/>
                        <input type="submit" value="Login"/>
                    </form>

                    <form onSubmit={this.signUp}>
                        <input type="submit" value="Sign up"/>
                    </form>
                </div>
            );
        },
        login: function (e) {
            e.preventDefault();

            var vars = JSON.stringify({
                username: this.refs.username.value,
                password: this.refs.password.value
            });

            fetch('/users/login', {
                method: 'post',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: vars
            }).then(res => {
                if(res.status === 200) {
                    res.text().then(apiKey => {
                        document.getElementById('apiKey').textContent = apiKey;
                        ReactDOM.render(<Samples/>, document.getElementById('content'));
                    }).catch(err => console.log(err));
                } else {
                    alert("Wrong username/password");
                }
            }).catch(err => console.log(err));
        },
        signUp: function (e) {
            e.preventDefault();
            ReactDOM.render(<SignUp/>, document.getElementById('content'));
        }
    });

    ReactDOM.render(<Login/>, document.getElementById('content'));
    </script>
</body>
</html>